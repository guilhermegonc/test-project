{% extends "base.html" %}
{% block title %}Gestão financeira{% endblock %}
{% include "chart-js/chart.html"%}

{% load static %}
{% block extra-css %}
<link rel="stylesheet" type="text/css" href="{% static 'finance-styles.css' %}">
{% endblock %}
{% block extra-js %}
    <script src="{% static 'monthly-summary.js' %}"></script>
    <script src="{% static 'dashboard-cards.js' %}"></script>
    <script src="{% static 'edit-modal.js' %}"></script>
    <script src="{% static 'finance-chart.js' %}"></script>
    <script src="{% static 'general-table.js' %}"></script>
    <script src="{% static 'finance-summary-table.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.js"></script>
    {% endblock %}

{% block content%}
<div class="txt-center m-a m-b-24 light w-400">
    <h1 id="title" class="s3 m-a m-b-24">
        <span id="title-text">Esse mês</span>
        <span id="title-month-value" class="hide"></span>
        <span id="title-year-value" class="hide"></span>
    </h1>
    <i id="previous" class="material-icons icon-hover icon-adjust p-12 shadow">arrow_back</i>
    <i id="next" class="material-icons icon-hover icon-adjust p-12 shadow">arrow_forward</i>
</div>
<div class="txt-center m-b-24">
    <div id="summary" class="m-b-24 header-scroll"></div>
</div>
<div class="m-b-24 light">
    <h2 class="s6 db-results m-b-12 txt-center">Detalhes</h2>
</div>
<div id="chart" class="shadow summary-card chart-card">
    <h3 class="s8 txt-center p-12">Despesas</p>
    <canvas id="expense-chart"></canvas>
</div>
<div id="details-expenses">
</div>
<div id="details-savings">
</div>
<div class="footer-btn fl-r">
    <a class="btn light m-b-12" href="/">Início</a>
</div>
<script>
    const token = `{% csrf_token %}`
    const formExpense = `{{ form_expense }}`
    const formSaving = `{{ form_saving }}`
    
    const date = new Date()
    const div = document.querySelector('#summary')

    let val
    let categoryAverages = {}
    '{% for k,v in expenses_category.items %}'
        val = {{ v }}
        categoryAverages['{{ k }}'] = val.toFixed(2)
    '{% endfor %}'

    let avg
    const expensesMonth = {}
    const expenseCategories = {}
    '{% for k,v in expenses.items %}'
        expensesMonth['{{ k }}'] = 0
        expenseCategories['{{ k }}'] = {}
        '{% for type in v %}'
            '{% for name, value in type.items %}'
                expensesMonth['{{ k }}'] += {{ value }}
                avg = categoryAverages['{{ name }}']
                val = {{ value }}
                expenseCategories['{{ k }}']['{{ name }}'] = `${val.toFixed(2)}<br>(R$ ${avg})`
            '{% endfor %}'
            delete expenseCategories['{{ k }}'][''];
        '{% endfor %}'
    '{% endfor %}'
    
    const expenseValues = []
    for (m in expensesMonth) {
        expenseValues.push(expensesMonth[m])
    }

    let savings = {}
    '{% for k,v in savings.items %}'
        savings['{{ k }}'] = {{ v }}
    '{% endfor %}'

    let savingBalances = {}
    '{% for k, v in saving_balances.items %}'
        val = {{ v }}
        savingBalances['{{ k }}'] = val.toFixed(2)
    '{% endfor %}'

    let goals = {}
    let goalExpValues = []
    '{% for k, v in goals.items %}'
        goals['{{ k }}'] = [{{ v.0 }}, {{ v.1 }}]
        goalExpValues.push({{ v.0 }})
    '{% endfor %}'

    setupPage()
</script>
{% endblock %}